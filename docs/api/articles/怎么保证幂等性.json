{"title":"怎么保证幂等性","slug":"怎么保证幂等性","date":"2022-09-27T08:28:07.623Z","updated":"2023-07-04T06:07:56.791Z","comments":true,"path":"api/articles/怎么保证幂等性.json","excerpt":null,"covers":"https://pica.zhimg.com/v2-ea67086e75e2232aed42370e4b5728ff_r.jpg","content":"\r\n\r\n### 幂等性的几种方案\r\n\r\n1. 唯一索引，防止新增脏数据\r\n2. 前端限制:页面的提交按钮只能被点击提交一次\r\n   后端解决方案：\r\n    1. 集群环境：采用token加redis（redis单线程的，处理需要排队）\r\n    2. 单JVM环境：采用token加redis或token加jvm内存\r\n    3. 处理流程：请求前先生成token，重复代表处理过.数据提交前向授权系统申请token，系统根据相关信息生成token并判断是否可以返回（根据代码逻辑将生成的token与已生成且保存的token做对比，token一致的话代表已经生成了一次，本次不允许返回），将生成的token放到redis或jvm内存，并设置token的有效时间，返回给客户端\r\n    ![](images/mideng.jpg)\r\n       客户端携带token请求服务端，服务端查询redis，如果有的话处理请求并删除token，没有的话代表非法请求不做处理\r\n\r\n> 现在很多系统处理请求已经不做是否登陆的校验，而是根据用户名密码申请token，将token保存到cookie或者Local Storage或者form隐藏域，请求时携带token，服务端校验处理请求\r\n> [Token多平台身份认证架构设计思路](https://mp.weixin.qq.com/s/X4J56Y2dLzkBVwCC2hlmaQ)\r\n> [Token登录认证详解](https://blog.csdn.net/GreenSky_Test/article/details/116056661)\r\n3. 悲观锁获取数据的时候加锁获取\r\n```sql\r\nselect * from table_xxx where id='xxx' for update;\r\n```\r\n注意：id字段一定是主键或者唯一索引\r\n悲观锁使用时一般伴随事务一起使用，数据锁定时间可能会很长，根据实际情况选用\r\n4. 乐观锁:乐观锁只是在更新数据那一刻锁表，其他时间不锁表，所以相对于悲观锁，效率更高。乐观锁的实现方式多种多样可以通过version或者其他状态条件：\r\n```sql\r\n-- 通过版本号实现\r\nupdate table_xxx set name=#name#,version=version+1 where version=#version#\r\n-- 通过条件限制\r\nupdate tablexxx set avaiamount=avaiamount-#subAmount# where avaiamount-#subAmount# >= 0\r\n```\r\n5. 分布式锁\r\n6. 状态机幂等\r\n在设计单据相关的业务，或者是任务相关的业务，肯定会涉及到状态机(状态变更图)，就是业务单据上面有个状态，状态在不同的情况下会发生变更，一般情况下存在有限状态机,如果状态机已经处于下一个状态，这时候来了一个上一个状态的变更，理论上是不能够变更的，这样的话，保证了有限状态机的幂等。注意：订单等单据类业务，存在很长的状态流转，一定要深刻理解状态机，对业务系统设计能力提高有很大帮助\r\n7. 利用唯一请求编号去重，借用Redis做这个去重——只要这个唯一请求编号在redis存在，证明处理过，那么就认为是重复的\r\n\r\n#### 幂等性相关文章\r\n\r\n- [拒绝接口裸奔！开放API接口签名验证！](https://mp.weixin.qq.com/s/eVHScVN2kcuZaokzs6-QxA)\r\n- [面试问：你的项目是如何处理重复请求/并发请求的？](https://mp.weixin.qq.com/s/BENMPLwH8WG60UVL5vXj0A)\r\n- [Spring Boot实现接口幂等性的4种方案](https://mp.weixin.qq.com/s/nza76CX-UJxspSTl52B8eQ)\r\n- [高并发下如何保证接口的幂等性？](https://mp.weixin.qq.com/s/3FJQYVoh_MDXBT0wHoKksQ)\r\n- [分布式幂等性如何保证](https://mp.weixin.qq.com/s/Hd4T8aqrx8gTmkLRyl7hcA)\r\n- [消息幂等（去重）通用解决方案，写得真好](https://mp.weixin.qq.com/s/Rax8Qb-DrYNpkbc6eTtRlg)\r\n- [面试官：给我一个避免消息重复消费的解决方案？](https://mp.weixin.qq.com/s/aKStFQXAlFF-1dOax5xg4Q)\r\n- [处理接口幂等性的两种常见方案|手把手教你](https://mp.weixin.qq.com/s?__biz=MzI1NDY0MTkzNQ==&amp;mid=2247497775&amp;idx=1&amp;sn=02f389bfbdb280314e4db32660cd5bc5&amp;scene=21#wechat_redirect)\r\n- [如何防止订单重复支付？](https://mp.weixin.qq.com/s/ryhX9usir_d-O8eJuItWzA)\r\n- [保证接口数据安全的10种方案](https://mp.weixin.qq.com/s/aQwcHv36y0Du4w9HxT5FSw)\r\n- [如何防止接口重复提交？（上）](https://mp.weixin.qq.com/s/6WIlEnyYtpO50hAsO4EFNg)\r\n- [如何防止接口重复提交？（中）](https://mp.weixin.qq.com/s/RrMGoR4DgC7esfWjsX0-Lg)\r\n- [如何防止接口重复提交？（下）](https://mp.weixin.qq.com/s/Wedb1MyybIXdQEp5xvnxLw)\r\n- [并发扣款，如何保证一致性](https://mp.weixin.qq.com/s/2bhhEM8UG8AgIga0RxpW3g)\r\n- [一种非侵入式幂等性的Java实现](https://mp.weixin.qq.com/s/bktHm67TBWnNi6-xsM3-NA)\r\n\r\n### 微服务系统如何设计一个安全的API\r\n\r\n1. 身份认证问题\r\n一般情况下服务端均会向客户端颁发appId、partnerId等类似于标识用户身份的唯一ID，此ID关联用户密钥，一旦服务端异常或者受到工具，可以追溯来源，调整ID状态或者来强制下线用户\r\n2. 信息泄露问题\r\n信息泄露主要是要控制报文在网络传输中不要明文传输，根据对称和非对称加密算法的特点，目前主流的做法是使用混合加密，主要流程是，服务端创建RSA密钥对，将公钥传输给客户端，同时客户端创建AES密钥，使用AES密钥加密明文得到密文，接着使用公钥加密AES密钥，最后将加密后的AES密钥和密文传输到服务端。服务端使用自己的私钥解密加密后的AES密钥得到AES密钥，接着使用AES密钥解密密文得到明文\r\n3. 请求被篡改问题\r\n防止请求被篡改主要是要做好加签和验签\r\n4. 重放攻击问题\r\n黑客监听到请求后，重复请求攻击服务端，服务端如何识别是非法请求\r\n在请求参数中增加timestamp、randomString参数【此参数是从服务端实时请求的】，服务端在接收到请求后timestamp时间戳和服务端相差1分中之内的才放行，接着判断randomString是否已经存在，如果存在则不响应\r\n\r\n### 秒杀\r\n\r\n#### 步骤\r\n\r\n写脚本肯定需要知道步骤是什么，然后才能用代码去复刻下来嘛。\r\n\r\n1、下载浏览器驱动，这里我用的是chrome浏览器，先看一下自己的版本号，在设置可以看到。\r\n\r\n然后在[网站](http://chromedriver.storage.googleapis.com/index.html)找好对应的版本去下载\r\n\r\n2、接下来就是设置秒杀时间\r\n\r\n3、打开浏览器输入淘宝网址\r\n\r\n4、登录账号，进入购物车页面\r\n\r\n5、点击选择按钮\r\n\r\n6、秒杀时间到了，立刻下单！\r\n\r\n#### 操作开始\r\n\r\n导入依赖：\r\n\r\n```xml\r\n<dependency>\r\n      <groupId>org.seleniumhq.selenium</groupId>\r\n      <artifactId>selenium-java</artifactId>\r\n      <version>3.141.59</version>\r\n</dependency>\r\n```\r\n\r\n下面是完整的代码\r\n\r\n```java\r\npublic void taoBao() throws Exception {\r\n    // 浏览器驱动路径\r\n    System.setProperty(\"webdriver.chrome.driver\",\"D:\\\\JDK\\\\chromedriver.exe\");\r\n    // 设置秒杀时间\r\n    SimpleDateFormat sdf = new SimpleDateFormat(\"yyyy-MM-dd HH:mm:ss SSSSSSSSS\");\r\n    Date date = sdf.parse(\"2022-04-14 14:07:00 000000000\");\r\n    // 1、打开浏览器\r\n    ChromeDriver browser = new ChromeDriver();\r\n    Actions actions = new Actions(browser);\r\n    // 2、输入网址\r\n    browser.get(\"https://www.taobao.com\");\r\n    Thread.sleep(3000);\r\n    // 3、点击登录\r\n    browser.findElement(By.linkText(\"亲，请登录\")).click();\r\n    Thread.sleep(2000);\r\n    // 4、扫码登录\r\n    browser.findElement(By.className(\"icon-qrcode\")).click();\r\n    Thread.sleep(4000);\r\n    // 5、进入购物车页面\r\n    browser.get(\"https://cart.taobao.com/cart.htm\");\r\n    Thread.sleep(3000);\r\n    // 6、点击选择第一个按钮\r\n    browser.findElement(By.xpath(\"//*[@id=\\\"J_Order_s_2207407355826_1\\\"]/div[1]/div/div/label\")).click();\r\n    Thread.sleep(2000);\r\n    while (true){\r\n        //当前时间\r\n        Date now = new Date();\r\n        System.out.println(now);\r\n        if(now.after(date)){\r\n            if(browser.findElement(By.linkText(\"结 算\")).isEnabled()){\r\n                browser.findElement(By.linkText(\"结 算\")).click();\r\n                System.out.println(\"结算成功\");\r\n                break;\r\n            }\r\n\r\n        }\r\n    }\r\n    Thread.sleep(5000);\r\n}\r\n```\r\n\r\n这里说一下会遇到的问题：\r\n\r\n1. 这里使用的是扫码登录，需要用手机淘宝扫码进行登录\r\n2. Thread.sleep(4000);就是系统休息4秒钟，如果扫码登录时间大于4秒会报错，可以根据电脑网速来设置\r\n3. browser.findElement(By.xpath(\"xxx\")).click();这个是选择购物车第一个商家的所有商品，里面xxx需要更改。当然其他参数怎么修改可以根据这个对应来修改。\r\n\r\n进入购物车页面后按F12，然后点左上角那个箭头，然后选择店铺左边的按钮，这样下面代码块就对应到了指定的代码位置\r\n\r\n![图片](https://img-blog.csdnimg.cn/b2f3301c394e498eaa8fb7bb87477317.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA6L6w5YWuaW5n,size_20,color_FFFFFF,t_70,g_se,x_16)\r\n\r\n右键这一行，然后选择copy→Copy XPath，这个XPath就是browser.findElement(By.xpath(\"xxx\")).click();的xxx内容\r\n\r\n![图片](https://img-blog.csdnimg.cn/c816562669b74a729443ff134c5f0b07.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA6L6w5YWuaW5n,size_20,color_FFFFFF,t_70,g_se,x_16)\r\n\r\n如果以上操作都没有问题，那么你就可以启动程序啦！！成功后你会发现，脚本居然如此简单！！\r\n\r\n- [面试官：你给我画一下秒杀系统的架构图](https://mp.weixin.qq.com/s/EYx78REElJE3ASm1PCG2aw)\r\n- [秒杀场景的九个细节，细思极恐！](https://mp.weixin.qq.com/s/Uq0zM_ceoFupYDKqqpvR4Q)\r\n- [秒杀系统设计最全攻略](https://mp.weixin.qq.com/s/2LpNQTmSFu0InYnC-Q7bJA)\r\n- [下次二面再回答不好“秒杀系统“设计原理，我就捶死自己...](https://mp.weixin.qq.com/s/YHhbonAxNntonTo-UhDV6Q)\r\n- [如何设计订单系统](https://mp.weixin.qq.com/s/AtXswrVQPGD_jfSqzKe_qQ)\r\n- [千万级高并发秒杀系统设计套路](https://mp.weixin.qq.com/s/KmPY2NOfpftFi6TpVSW23Q)\r\n\r\n","categories":[],"tags":[{"name":"随笔","path":"api/tags/随笔.json"}]}