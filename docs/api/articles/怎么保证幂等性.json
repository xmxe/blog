{"title":"怎么保证幂等性","slug":"怎么保证幂等性","date":"2022-09-27T08:28:07.623Z","updated":"2023-04-04T05:44:48.265Z","comments":true,"path":"api/articles/怎么保证幂等性.json","excerpt":null,"covers":"https://pica.zhimg.com/v2-ea67086e75e2232aed42370e4b5728ff_r.jpg","content":"<h3 id=\"幂等性的几种方案\"><a href=\"#幂等性的几种方案\" class=\"headerlink\" title=\"幂等性的几种方案\"></a>幂等性的几种方案</h3><ol>\n<li>唯一索引，防止新增脏数据</li>\n<li>token机制，防止页面重复提交<br>前端限制:页面的提交按钮只能被点击提交一次<br>后端解决方案：<br>集群环境：采用token加redis（redis单线程的，处理需要排队）<br>单JVM环境：采用token加redis或token加jvm内存<br>处理流程：请求前先生成token，重复代表处理过.数据提交前向授权系统申请token，系统根据相关信息生成token并判断是否可以返回（根据代码逻辑将生成的token与已生成且保存的token做对比，token一致的话代表已经生成了一次，本次不允许返回），将生成的token放到redis或jvm内存，并设置token的有效时间，返回给客户端<br><img src=\"/blog/images/mideng.jpg\"><br>客户端携带token请求服务端，服务端查询redis，如果有的话处理请求并删除token，没有的话代表非法请求不做处理</li>\n</ol>\n<blockquote>\n<p>现在很多系统处理请求已经不做是否登陆的校验，而是根据用户名密码申请token，将token保存到cookie或者Local Storage或者form隐藏域，请求时携带token，服务端校验处理请求</p>\n</blockquote>\n<p><a href=\"https://mp.weixin.qq.com/s/X4J56Y2dLzkBVwCC2hlmaQ\">Token多平台身份认证架构设计思路</a><br><a href=\"https://blog.csdn.net/GreenSky_Test/article/details/116056661\">Token登录认证详解</a><br>3. 悲观锁获取数据的时候加锁获取</p>\n<pre class=\"line-numbers language-sql\" data-language=\"sql\"><code class=\"language-sql\"><span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> table_xxx <span class=\"token keyword\">where</span> id<span class=\"token operator\">=</span><span class=\"token string\">'xxx'</span> <span class=\"token keyword\">for</span> <span class=\"token keyword\">update</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p>注意：id字段一定是主键或者唯一索引<br>悲观锁使用时一般伴随事务一起使用，数据锁定时间可能会很长，根据实际情况选用<br>4. 乐观锁:乐观锁只是在更新数据那一刻锁表，其他时间不锁表，所以相对于悲观锁，效率更高。乐观锁的实现方式多种多样可以通过version或者其他状态条件：</p>\n<pre class=\"line-numbers language-sql\" data-language=\"sql\"><code class=\"language-sql\"><span class=\"token comment\">-- 通过版本号实现</span>\n<span class=\"token keyword\">update</span> table_xxx <span class=\"token keyword\">set</span> name<span class=\"token operator\">=</span><span class=\"token comment\">#name#,version=version+1 where version=#version#</span>\n<span class=\"token comment\">-- 通过条件限制</span>\n<span class=\"token keyword\">update</span> tablexxx <span class=\"token keyword\">set</span> avaiamount<span class=\"token operator\">=</span>avaiamount<span class=\"token operator\">-</span><span class=\"token comment\">#subAmount# where avaiamount-#subAmount# >= 0</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n<ol start=\"5\">\n<li>分布式锁</li>\n<li>状态机幂等<br>在设计单据相关的业务，或者是任务相关的业务，肯定会涉及到状态机(状态变更图)，就是业务单据上面有个状态，状态在不同的情况下会发生变更，一般情况下存在有限状态机,如果状态机已经处于下一个状态，这时候来了一个上一个状态的变更，理论上是不能够变更的，这样的话，保证了有限状态机的幂等。注意：订单等单据类业务，存在很长的状态流转，一定要深刻理解状态机，对业务系统设计能力提高有很大帮助</li>\n<li>利用唯一请求编号去重，借用Redis做这个去重——只要这个唯一请求编号在redis存在，证明处理过，那么就认为是重复的</li>\n</ol>\n<h4 id=\"幂等性相关文章\"><a href=\"#幂等性相关文章\" class=\"headerlink\" title=\"幂等性相关文章\"></a>幂等性相关文章</h4><ul>\n<li><a href=\"https://mp.weixin.qq.com/s/eVHScVN2kcuZaokzs6-QxA\">拒绝接口裸奔！开放API接口签名验证！</a></li>\n<li><a href=\"https://mp.weixin.qq.com/s/BENMPLwH8WG60UVL5vXj0A\">面试问：你的项目是如何处理重复请求&#x2F;并发请求的？</a></li>\n<li><a href=\"https://mp.weixin.qq.com/s/nza76CX-UJxspSTl52B8eQ\">Spring Boot实现接口幂等性的4种方案</a></li>\n<li><a href=\"https://mp.weixin.qq.com/s/3FJQYVoh_MDXBT0wHoKksQ\">高并发下如何保证接口的幂等性？</a></li>\n<li><a href=\"https://mp.weixin.qq.com/s/Hd4T8aqrx8gTmkLRyl7hcA\">分布式幂等性如何保证</a></li>\n<li><a href=\"https://mp.weixin.qq.com/s/Rax8Qb-DrYNpkbc6eTtRlg\">消息幂等（去重）通用解决方案，写得真好</a></li>\n<li><a href=\"https://mp.weixin.qq.com/s/aKStFQXAlFF-1dOax5xg4Q\">面试官：给我一个避免消息重复消费的解决方案？</a></li>\n<li><a href=\"https://mp.weixin.qq.com/s?__biz=MzI1NDY0MTkzNQ==&amp;mid=2247497775&amp;idx=1&amp;sn=02f389bfbdb280314e4db32660cd5bc5&amp;scene=21#wechat_redirect\">处理接口幂等性的两种常见方案|手把手教你</a></li>\n<li><a href=\"https://mp.weixin.qq.com/s/ryhX9usir_d-O8eJuItWzA\">如何防止订单重复支付？</a></li>\n<li><a href=\"https://mp.weixin.qq.com/s/aQwcHv36y0Du4w9HxT5FSw\">保证接口数据安全的10种方案</a></li>\n<li><a href=\"https://mp.weixin.qq.com/s/6WIlEnyYtpO50hAsO4EFNg\">如何防止接口重复提交？（上）</a></li>\n<li><a href=\"https://mp.weixin.qq.com/s/RrMGoR4DgC7esfWjsX0-Lg\">如何防止接口重复提交？（中）</a></li>\n<li><a href=\"https://mp.weixin.qq.com/s/Wedb1MyybIXdQEp5xvnxLw\">如何防止接口重复提交？（下）</a></li>\n<li><a href=\"https://mp.weixin.qq.com/s/2bhhEM8UG8AgIga0RxpW3g\">并发扣款，如何保证一致性</a></li>\n<li><a href=\"https://mp.weixin.qq.com/s/bktHm67TBWnNi6-xsM3-NA\">一种非侵入式幂等性的Java实现</a></li>\n</ul>\n<h3 id=\"微服务系统如何设计一个安全的API\"><a href=\"#微服务系统如何设计一个安全的API\" class=\"headerlink\" title=\"微服务系统如何设计一个安全的API\"></a>微服务系统如何设计一个安全的API</h3><ol>\n<li>身份认证问题<br>一般情况下服务端均会向客户端颁发appId、partnerId等类似于标识用户身份的唯一ID，此ID关联用户密钥，一旦服务端异常或者受到工具，可以追溯来源，调整ID状态或者来强制下线用户</li>\n<li>信息泄露问题<br>信息泄露主要是要控制报文在网络传输中不要明文传输，根据对称和非对称加密算法的特点，目前主流的做法是使用混合加密，主要流程是，服务端创建RSA密钥对，将公钥传输给客户端，同时客户端创建AES密钥，使用AES密钥加密明文得到密文，接着使用公钥加密AES密钥，最后将加密后的AES密钥和密文传输到服务端。服务端使用自己的私钥解密加密后的AES密钥得到AES密钥，接着使用AES密钥解密密文得到明文</li>\n<li>请求被篡改问题<br>防止请求被篡改主要是要做好加签和验签</li>\n<li>重放攻击问题<br>黑客监听到请求后，重复请求攻击服务端，服务端如何识别是非法请求<br>在请求参数中增加timestamp、randomString参数【此参数是从服务端实时请求的】，服务端在接收到请求后timestamp时间戳和服务端相差1分中之内的才放行，接着判断randomString是否已经存在，如果存在则不响应</li>\n</ol>\n<h3 id=\"秒杀\"><a href=\"#秒杀\" class=\"headerlink\" title=\"秒杀\"></a>秒杀</h3><h4 id=\"步骤\"><a href=\"#步骤\" class=\"headerlink\" title=\"步骤\"></a>步骤</h4><p>写脚本肯定需要知道步骤是什么，然后才能用代码去复刻下来嘛。</p>\n<p>1、下载浏览器驱动，这里我用的是chrome浏览器，先看一下自己的版本号，在设置可以看到。</p>\n<p>然后在<a href=\"http://chromedriver.storage.googleapis.com/index.html\">网站</a>找好对应的版本去下载</p>\n<p>2、接下来就是设置秒杀时间</p>\n<p>3、打开浏览器输入淘宝网址</p>\n<p>4、登录账号，进入购物车页面</p>\n<p>5、点击选择按钮</p>\n<p>6、秒杀时间到了，立刻下单！</p>\n<h4 id=\"操作开始\"><a href=\"#操作开始\" class=\"headerlink\" title=\"操作开始\"></a>操作开始</h4><p>导入依赖：</p>\n<pre class=\"line-numbers language-markup\" data-language=\"markup\"><code class=\"language-markup\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">></span></span>org.seleniumhq.selenium<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">></span></span>selenium-java<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>version</span><span class=\"token punctuation\">></span></span>3.141.59<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>version</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">></span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>下面是完整的代码</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">taoBao</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token comment\">// 浏览器驱动路径</span>\n    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span><span class=\"token function\">setProperty</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"webdriver.chrome.driver\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"D:\\\\JDK\\\\chromedriver.exe\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// 设置秒杀时间</span>\n    <span class=\"token class-name\">SimpleDateFormat</span> sdf <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SimpleDateFormat</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"yyyy-MM-dd HH:mm:ss SSSSSSSSS\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Date</span> date <span class=\"token operator\">=</span> sdf<span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"2022-04-14 14:07:00 000000000\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// 1、打开浏览器</span>\n    <span class=\"token class-name\">ChromeDriver</span> browser <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ChromeDriver</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Actions</span> actions <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Actions</span><span class=\"token punctuation\">(</span>browser<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// 2、输入网址</span>\n    browser<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"https://www.taobao.com\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">3000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// 3、点击登录</span>\n    browser<span class=\"token punctuation\">.</span><span class=\"token function\">findElement</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">By</span><span class=\"token punctuation\">.</span><span class=\"token function\">linkText</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"亲，请登录\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">click</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">2000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// 4、扫码登录</span>\n    browser<span class=\"token punctuation\">.</span><span class=\"token function\">findElement</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">By</span><span class=\"token punctuation\">.</span><span class=\"token function\">className</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"icon-qrcode\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">click</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">4000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// 5、进入购物车页面</span>\n    browser<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"https://cart.taobao.com/cart.htm\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">3000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// 6、点击选择第一个按钮</span>\n    browser<span class=\"token punctuation\">.</span><span class=\"token function\">findElement</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">By</span><span class=\"token punctuation\">.</span><span class=\"token function\">xpath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"//*[@id=\\\"J_Order_s_2207407355826_1\\\"]/div[1]/div/div/label\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">click</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">2000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n        <span class=\"token comment\">//当前时间</span>\n        <span class=\"token class-name\">Date</span> now <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>now<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>now<span class=\"token punctuation\">.</span><span class=\"token function\">after</span><span class=\"token punctuation\">(</span>date<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>browser<span class=\"token punctuation\">.</span><span class=\"token function\">findElement</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">By</span><span class=\"token punctuation\">.</span><span class=\"token function\">linkText</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"结 算\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEnabled</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n                browser<span class=\"token punctuation\">.</span><span class=\"token function\">findElement</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">By</span><span class=\"token punctuation\">.</span><span class=\"token function\">linkText</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"结 算\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">click</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"结算成功\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">&#125;</span>\n\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">5000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>这里说一下会遇到的问题：</p>\n<ol>\n<li>这里使用的是扫码登录，需要用手机淘宝扫码进行登录</li>\n<li>Thread.sleep(4000);就是系统休息4秒钟，如果扫码登录时间大于4秒会报错，可以根据电脑网速来设置</li>\n<li>browser.findElement(By.xpath(“xxx”)).click();这个是选择购物车第一个商家的所有商品，里面xxx需要更改。当然其他参数怎么修改可以根据这个对应来修改。</li>\n</ol>\n<p>进入购物车页面后按F12，然后点左上角那个箭头，然后选择店铺左边的按钮，这样下面代码块就对应到了指定的代码位置</p>\n<p><img src=\"https://img-blog.csdnimg.cn/b2f3301c394e498eaa8fb7bb87477317.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA6L6w5YWuaW5n,size_20,color_FFFFFF,t_70,g_se,x_16\" alt=\"图片\"></p>\n<p>右键这一行，然后选择copy→Copy XPath，这个XPath就是browser.findElement(By.xpath(“xxx”)).click();的xxx内容</p>\n<p><img src=\"https://img-blog.csdnimg.cn/c816562669b74a729443ff134c5f0b07.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA6L6w5YWuaW5n,size_20,color_FFFFFF,t_70,g_se,x_16\" alt=\"图片\"></p>\n<p>如果以上操作都没有问题，那么你就可以启动程序啦！！成功后你会发现，脚本居然如此简单！！</p>\n<ul>\n<li><a href=\"https://mp.weixin.qq.com/s/EYx78REElJE3ASm1PCG2aw\">面试官：你给我画一下秒杀系统的架构图</a></li>\n<li><a href=\"https://mp.weixin.qq.com/s/Uq0zM_ceoFupYDKqqpvR4Q\">秒杀场景的九个细节，细思极恐！</a></li>\n<li><a href=\"https://mp.weixin.qq.com/s/2LpNQTmSFu0InYnC-Q7bJA\">秒杀系统设计最全攻略</a></li>\n<li><a href=\"https://mp.weixin.qq.com/s/YHhbonAxNntonTo-UhDV6Q\">下次二面再回答不好“秒杀系统“设计原理，我就捶死自己…</a></li>\n<li><a href=\"https://mp.weixin.qq.com/s/AtXswrVQPGD_jfSqzKe_qQ\">如何设计订单系统</a></li>\n<li><a href=\"https://mp.weixin.qq.com/s/KmPY2NOfpftFi6TpVSW23Q\">千万级高并发秒杀系统设计套路</a></li>\n</ul>\n","more":"<h3 id=\"幂等性的几种方案\"><a href=\"#幂等性的几种方案\" class=\"headerlink\" title=\"幂等性的几种方案\"></a>幂等性的几种方案</h3><ol>\n<li>唯一索引，防止新增脏数据</li>\n<li>token机制，防止页面重复提交<br>前端限制:页面的提交按钮只能被点击提交一次<br>后端解决方案：<br>集群环境：采用token加redis（redis单线程的，处理需要排队）<br>单JVM环境：采用token加redis或token加jvm内存<br>处理流程：请求前先生成token，重复代表处理过.数据提交前向授权系统申请token，系统根据相关信息生成token并判断是否可以返回（根据代码逻辑将生成的token与已生成且保存的token做对比，token一致的话代表已经生成了一次，本次不允许返回），将生成的token放到redis或jvm内存，并设置token的有效时间，返回给客户端<br><img src=\"/blog/images/mideng.jpg\"><br>客户端携带token请求服务端，服务端查询redis，如果有的话处理请求并删除token，没有的话代表非法请求不做处理</li>\n</ol>\n<blockquote>\n<p>现在很多系统处理请求已经不做是否登陆的校验，而是根据用户名密码申请token，将token保存到cookie或者Local Storage或者form隐藏域，请求时携带token，服务端校验处理请求</p>\n</blockquote>\n<p><a href=\"https://mp.weixin.qq.com/s/X4J56Y2dLzkBVwCC2hlmaQ\">Token多平台身份认证架构设计思路</a><br><a href=\"https://blog.csdn.net/GreenSky_Test/article/details/116056661\">Token登录认证详解</a><br>3. 悲观锁获取数据的时候加锁获取</p>\n<pre class=\"line-numbers language-sql\" data-language=\"sql\"><code class=\"language-sql\"><span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> table_xxx <span class=\"token keyword\">where</span> id<span class=\"token operator\">=</span><span class=\"token string\">'xxx'</span> <span class=\"token keyword\">for</span> <span class=\"token keyword\">update</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p>注意：id字段一定是主键或者唯一索引<br>悲观锁使用时一般伴随事务一起使用，数据锁定时间可能会很长，根据实际情况选用<br>4. 乐观锁:乐观锁只是在更新数据那一刻锁表，其他时间不锁表，所以相对于悲观锁，效率更高。乐观锁的实现方式多种多样可以通过version或者其他状态条件：</p>\n<pre class=\"line-numbers language-sql\" data-language=\"sql\"><code class=\"language-sql\"><span class=\"token comment\">-- 通过版本号实现</span>\n<span class=\"token keyword\">update</span> table_xxx <span class=\"token keyword\">set</span> name<span class=\"token operator\">=</span><span class=\"token comment\">#name#,version=version+1 where version=#version#</span>\n<span class=\"token comment\">-- 通过条件限制</span>\n<span class=\"token keyword\">update</span> tablexxx <span class=\"token keyword\">set</span> avaiamount<span class=\"token operator\">=</span>avaiamount<span class=\"token operator\">-</span><span class=\"token comment\">#subAmount# where avaiamount-#subAmount# >= 0</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n<ol start=\"5\">\n<li>分布式锁</li>\n<li>状态机幂等<br>在设计单据相关的业务，或者是任务相关的业务，肯定会涉及到状态机(状态变更图)，就是业务单据上面有个状态，状态在不同的情况下会发生变更，一般情况下存在有限状态机,如果状态机已经处于下一个状态，这时候来了一个上一个状态的变更，理论上是不能够变更的，这样的话，保证了有限状态机的幂等。注意：订单等单据类业务，存在很长的状态流转，一定要深刻理解状态机，对业务系统设计能力提高有很大帮助</li>\n<li>利用唯一请求编号去重，借用Redis做这个去重——只要这个唯一请求编号在redis存在，证明处理过，那么就认为是重复的</li>\n</ol>\n<h4 id=\"幂等性相关文章\"><a href=\"#幂等性相关文章\" class=\"headerlink\" title=\"幂等性相关文章\"></a>幂等性相关文章</h4><ul>\n<li><a href=\"https://mp.weixin.qq.com/s/eVHScVN2kcuZaokzs6-QxA\">拒绝接口裸奔！开放API接口签名验证！</a></li>\n<li><a href=\"https://mp.weixin.qq.com/s/BENMPLwH8WG60UVL5vXj0A\">面试问：你的项目是如何处理重复请求&#x2F;并发请求的？</a></li>\n<li><a href=\"https://mp.weixin.qq.com/s/nza76CX-UJxspSTl52B8eQ\">Spring Boot实现接口幂等性的4种方案</a></li>\n<li><a href=\"https://mp.weixin.qq.com/s/3FJQYVoh_MDXBT0wHoKksQ\">高并发下如何保证接口的幂等性？</a></li>\n<li><a href=\"https://mp.weixin.qq.com/s/Hd4T8aqrx8gTmkLRyl7hcA\">分布式幂等性如何保证</a></li>\n<li><a href=\"https://mp.weixin.qq.com/s/Rax8Qb-DrYNpkbc6eTtRlg\">消息幂等（去重）通用解决方案，写得真好</a></li>\n<li><a href=\"https://mp.weixin.qq.com/s/aKStFQXAlFF-1dOax5xg4Q\">面试官：给我一个避免消息重复消费的解决方案？</a></li>\n<li><a href=\"https://mp.weixin.qq.com/s?__biz=MzI1NDY0MTkzNQ==&amp;mid=2247497775&amp;idx=1&amp;sn=02f389bfbdb280314e4db32660cd5bc5&amp;scene=21#wechat_redirect\">处理接口幂等性的两种常见方案|手把手教你</a></li>\n<li><a href=\"https://mp.weixin.qq.com/s/ryhX9usir_d-O8eJuItWzA\">如何防止订单重复支付？</a></li>\n<li><a href=\"https://mp.weixin.qq.com/s/aQwcHv36y0Du4w9HxT5FSw\">保证接口数据安全的10种方案</a></li>\n<li><a href=\"https://mp.weixin.qq.com/s/6WIlEnyYtpO50hAsO4EFNg\">如何防止接口重复提交？（上）</a></li>\n<li><a href=\"https://mp.weixin.qq.com/s/RrMGoR4DgC7esfWjsX0-Lg\">如何防止接口重复提交？（中）</a></li>\n<li><a href=\"https://mp.weixin.qq.com/s/Wedb1MyybIXdQEp5xvnxLw\">如何防止接口重复提交？（下）</a></li>\n<li><a href=\"https://mp.weixin.qq.com/s/2bhhEM8UG8AgIga0RxpW3g\">并发扣款，如何保证一致性</a></li>\n<li><a href=\"https://mp.weixin.qq.com/s/bktHm67TBWnNi6-xsM3-NA\">一种非侵入式幂等性的Java实现</a></li>\n</ul>\n<h3 id=\"微服务系统如何设计一个安全的API\"><a href=\"#微服务系统如何设计一个安全的API\" class=\"headerlink\" title=\"微服务系统如何设计一个安全的API\"></a>微服务系统如何设计一个安全的API</h3><ol>\n<li>身份认证问题<br>一般情况下服务端均会向客户端颁发appId、partnerId等类似于标识用户身份的唯一ID，此ID关联用户密钥，一旦服务端异常或者受到工具，可以追溯来源，调整ID状态或者来强制下线用户</li>\n<li>信息泄露问题<br>信息泄露主要是要控制报文在网络传输中不要明文传输，根据对称和非对称加密算法的特点，目前主流的做法是使用混合加密，主要流程是，服务端创建RSA密钥对，将公钥传输给客户端，同时客户端创建AES密钥，使用AES密钥加密明文得到密文，接着使用公钥加密AES密钥，最后将加密后的AES密钥和密文传输到服务端。服务端使用自己的私钥解密加密后的AES密钥得到AES密钥，接着使用AES密钥解密密文得到明文</li>\n<li>请求被篡改问题<br>防止请求被篡改主要是要做好加签和验签</li>\n<li>重放攻击问题<br>黑客监听到请求后，重复请求攻击服务端，服务端如何识别是非法请求<br>在请求参数中增加timestamp、randomString参数【此参数是从服务端实时请求的】，服务端在接收到请求后timestamp时间戳和服务端相差1分中之内的才放行，接着判断randomString是否已经存在，如果存在则不响应</li>\n</ol>\n<h3 id=\"秒杀\"><a href=\"#秒杀\" class=\"headerlink\" title=\"秒杀\"></a>秒杀</h3><h4 id=\"步骤\"><a href=\"#步骤\" class=\"headerlink\" title=\"步骤\"></a>步骤</h4><p>写脚本肯定需要知道步骤是什么，然后才能用代码去复刻下来嘛。</p>\n<p>1、下载浏览器驱动，这里我用的是chrome浏览器，先看一下自己的版本号，在设置可以看到。</p>\n<p>然后在<a href=\"http://chromedriver.storage.googleapis.com/index.html\">网站</a>找好对应的版本去下载</p>\n<p>2、接下来就是设置秒杀时间</p>\n<p>3、打开浏览器输入淘宝网址</p>\n<p>4、登录账号，进入购物车页面</p>\n<p>5、点击选择按钮</p>\n<p>6、秒杀时间到了，立刻下单！</p>\n<h4 id=\"操作开始\"><a href=\"#操作开始\" class=\"headerlink\" title=\"操作开始\"></a>操作开始</h4><p>导入依赖：</p>\n<pre class=\"line-numbers language-markup\" data-language=\"markup\"><code class=\"language-markup\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">></span></span>org.seleniumhq.selenium<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">></span></span>selenium-java<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>version</span><span class=\"token punctuation\">></span></span>3.141.59<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>version</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">></span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>下面是完整的代码</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">taoBao</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token comment\">// 浏览器驱动路径</span>\n    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span><span class=\"token function\">setProperty</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"webdriver.chrome.driver\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"D:\\\\JDK\\\\chromedriver.exe\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// 设置秒杀时间</span>\n    <span class=\"token class-name\">SimpleDateFormat</span> sdf <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SimpleDateFormat</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"yyyy-MM-dd HH:mm:ss SSSSSSSSS\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Date</span> date <span class=\"token operator\">=</span> sdf<span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"2022-04-14 14:07:00 000000000\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// 1、打开浏览器</span>\n    <span class=\"token class-name\">ChromeDriver</span> browser <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ChromeDriver</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Actions</span> actions <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Actions</span><span class=\"token punctuation\">(</span>browser<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// 2、输入网址</span>\n    browser<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"https://www.taobao.com\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">3000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// 3、点击登录</span>\n    browser<span class=\"token punctuation\">.</span><span class=\"token function\">findElement</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">By</span><span class=\"token punctuation\">.</span><span class=\"token function\">linkText</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"亲，请登录\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">click</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">2000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// 4、扫码登录</span>\n    browser<span class=\"token punctuation\">.</span><span class=\"token function\">findElement</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">By</span><span class=\"token punctuation\">.</span><span class=\"token function\">className</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"icon-qrcode\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">click</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">4000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// 5、进入购物车页面</span>\n    browser<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"https://cart.taobao.com/cart.htm\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">3000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// 6、点击选择第一个按钮</span>\n    browser<span class=\"token punctuation\">.</span><span class=\"token function\">findElement</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">By</span><span class=\"token punctuation\">.</span><span class=\"token function\">xpath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"//*[@id=\\\"J_Order_s_2207407355826_1\\\"]/div[1]/div/div/label\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">click</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">2000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n        <span class=\"token comment\">//当前时间</span>\n        <span class=\"token class-name\">Date</span> now <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>now<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>now<span class=\"token punctuation\">.</span><span class=\"token function\">after</span><span class=\"token punctuation\">(</span>date<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>browser<span class=\"token punctuation\">.</span><span class=\"token function\">findElement</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">By</span><span class=\"token punctuation\">.</span><span class=\"token function\">linkText</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"结 算\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEnabled</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n                browser<span class=\"token punctuation\">.</span><span class=\"token function\">findElement</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">By</span><span class=\"token punctuation\">.</span><span class=\"token function\">linkText</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"结 算\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">click</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"结算成功\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">&#125;</span>\n\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">5000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>这里说一下会遇到的问题：</p>\n<ol>\n<li>这里使用的是扫码登录，需要用手机淘宝扫码进行登录</li>\n<li>Thread.sleep(4000);就是系统休息4秒钟，如果扫码登录时间大于4秒会报错，可以根据电脑网速来设置</li>\n<li>browser.findElement(By.xpath(“xxx”)).click();这个是选择购物车第一个商家的所有商品，里面xxx需要更改。当然其他参数怎么修改可以根据这个对应来修改。</li>\n</ol>\n<p>进入购物车页面后按F12，然后点左上角那个箭头，然后选择店铺左边的按钮，这样下面代码块就对应到了指定的代码位置</p>\n<p><img src=\"https://img-blog.csdnimg.cn/b2f3301c394e498eaa8fb7bb87477317.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA6L6w5YWuaW5n,size_20,color_FFFFFF,t_70,g_se,x_16\" alt=\"图片\"></p>\n<p>右键这一行，然后选择copy→Copy XPath，这个XPath就是browser.findElement(By.xpath(“xxx”)).click();的xxx内容</p>\n<p><img src=\"https://img-blog.csdnimg.cn/c816562669b74a729443ff134c5f0b07.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA6L6w5YWuaW5n,size_20,color_FFFFFF,t_70,g_se,x_16\" alt=\"图片\"></p>\n<p>如果以上操作都没有问题，那么你就可以启动程序啦！！成功后你会发现，脚本居然如此简单！！</p>\n<ul>\n<li><a href=\"https://mp.weixin.qq.com/s/EYx78REElJE3ASm1PCG2aw\">面试官：你给我画一下秒杀系统的架构图</a></li>\n<li><a href=\"https://mp.weixin.qq.com/s/Uq0zM_ceoFupYDKqqpvR4Q\">秒杀场景的九个细节，细思极恐！</a></li>\n<li><a href=\"https://mp.weixin.qq.com/s/2LpNQTmSFu0InYnC-Q7bJA\">秒杀系统设计最全攻略</a></li>\n<li><a href=\"https://mp.weixin.qq.com/s/YHhbonAxNntonTo-UhDV6Q\">下次二面再回答不好“秒杀系统“设计原理，我就捶死自己…</a></li>\n<li><a href=\"https://mp.weixin.qq.com/s/AtXswrVQPGD_jfSqzKe_qQ\">如何设计订单系统</a></li>\n<li><a href=\"https://mp.weixin.qq.com/s/KmPY2NOfpftFi6TpVSW23Q\">千万级高并发秒杀系统设计套路</a></li>\n</ul>\n","categories":[],"tags":[{"name":"随笔","path":"api/tags/随笔.json"}]}